# Nmodm v3.1.3 版本总结

**发布日期**: 2025-01-20  
**版本类型**: Bug 修复版本

---

## 📋 版本概述

v3.1.3 是一个重要的 bug 修复版本，主要解决了用户界面文本缺失和中文文件名乱码两个关键问题，提升了用户体验和软件稳定性。

---

## 🐛 Bug 修复

### 1. 快速启动页面文本缺失问题

**问题描述**:
- "编辑预设方案"对话框中多个标签文本显示为空
- 受影响的标签包括：方案名称、文件名、方案描述、选择图标、Mod包、DLL文件等

**根本原因**:
- 翻译文件 `quick_launch_page.json` 中存在两个重复的 `"label"` 键
- JSON 格式中，后面的键会覆盖前面的键，导致前面定义的所有标签翻译丢失

**修复方案**:
- 合并两个 `label` 部分，将 `mod_packages` 键移到第一个 `label` 部分
- 删除重复的第二个 `label` 定义
- 同时修复了中文和英文翻译文件

**影响文件**:
- `src/i18n/locales/zh_CN/quick_launch_page.json`
- `src/i18n/locales/en_US/quick_launch_page.json`

---

### 2. OnlineFix 工具包中文文件名乱码问题

**问题描述**:
- 下载并解压 OnlineFix 工具包后，中文文件名显示为乱码
- 例如："无缝手柄问题解决方案.png" 显示为乱码字符

**根本原因**:
- Windows 下创建的 ZIP 文件通常使用 GBK/GB2312 编码存储中文文件名
- Python 的 `zipfile` 模块默认使用 CP437 或 UTF-8 编码读取文件名
- 编码不匹配导致中文文件名解码错误

**修复方案**:
- 在解压过程中添加编码转换逻辑
- 尝试使用 `cp437 -> gbk` 转码修复文件名
- 如果转码失败，回退到使用原始文件名，确保不会因编码问题导致解压失败

**修复代码**:
```python
# 修复中文文件名编码问题
try:
    # ZIP 文件可能使用 CP437 编码存储中文文件名
    # 尝试使用 GBK 编码重新解码
    filename = file_info.filename.encode('cp437').decode('gbk')
except (UnicodeDecodeError, UnicodeEncodeError):
    # 如果转码失败，使用原始文件名
    filename = file_info.filename
```

**影响文件**:
- `src/utils/download_manager.py` - `extract_onlinefix()` 方法

---

## 📝 文档更新

### 更新的文档
1. **版本号文件**
   - `src/version.json`: 3.1.2 → 3.1.3

2. **更新日志**
   - `docs/zh/CHANGELOG.md`: 添加 v3.1.3 更新记录（中文）
   - `docs/en/CHANGELOG.md`: 添加 v3.1.3 更新记录（英文）

3. **版本总结**
   - `docs/当前版本总结_v3.1.3.md`: 本文档

---

## 🔧 技术细节

### 翻译文件结构改进

**修复前**:
```json
{
  "label": {
    "name": "方案名称:",
    "filename": "文件名:",
    ...
  },
  ...
  "label": {
    "mod_packages": "Mod包 (Packages):"
  }
}
```

**修复后**:
```json
{
  "label": {
    "name": "方案名称:",
    "filename": "文件名:",
    "mod_packages": "Mod包 (Packages):",
    ...
  }
}
```

### ZIP 编码处理流程

1. **读取 ZIP 文件**: 使用 `zipfile.ZipFile` 打开压缩包
2. **遍历文件**: 获取 `file_info.filename`（可能是乱码）
3. **编码转换**: 
   - 尝试 `encode('cp437')` 将字符串转为字节
   - 再 `decode('gbk')` 使用 GBK 解码
4. **异常处理**: 如果转换失败，使用原始文件名
5. **提取文件**: 正常解压到目标目录

---

## 📊 影响范围

### 受益用户
- 所有使用"快速启动"功能的用户
- 所有下载 OnlineFix 工具包的用户
- 特别是中文环境下的用户

### 兼容性
- ✅ 向后兼容：不影响现有功能
- ✅ 跨平台：修复主要针对 Windows 平台
- ✅ 编码兼容：支持 GBK、UTF-8 等多种编码

---

## 🎯 测试建议

### 测试场景 1: 编辑预设方案
1. 打开"快速启动"页面
2. 点击"📝 编辑预设方案"按钮
3. 在"创建预设"选项卡中，检查所有标签是否正常显示：
   - ✅ 方案名称
   - ✅ 文件名
   - ✅ 方案描述
   - ✅ 选择图标
   - ✅ Mod包 (Packages)
   - ✅ DLL文件 (Natives)

### 测试场景 2: OnlineFix 解压
1. 删除现有的 OnlineFix 目录（如果存在）
2. 在"配置"页面点击"下载 OnlineFix"
3. 等待下载和自动解压完成
4. 检查 OnlineFix 目录中的文件名：
   - ✅ "无缝手柄问题解决方案.png" 显示正常
   - ✅ 其他中文文件名显示正常

---

## 🚀 升级指南

### 从 v3.1.2 升级

**方式 1: 使用安装包（推荐）**
1. 下载 `Nmodm_v3.1.3-Setup.exe`
2. 运行安装程序（会自动覆盖旧版本）
3. 启动 Nmodm，版本号应显示为 v3.1.3

**方式 2: 使用便携版**
1. 下载 `Nmodm_v3.1.3.zip`
2. 解压到新目录
3. 复制旧版本的配置文件（可选）：
   - `config.json`
   - `Mods/` 目录
   - `OnlineFix/` 目录

**注意事项**:
- ⚠️ 如果之前下载过 OnlineFix，建议重新下载以修复文件名
- ✅ 所有配置和数据都会保留
- ✅ 不需要重新配置游戏路径

---

## 📞 反馈与支持

如果您在使用过程中遇到问题，请通过以下方式反馈：

- 🐛 [报告 Bug](https://github.com/QykXczj/Nmodm/issues)
- 💡 [功能建议](https://github.com/QykXczj/Nmodm/issues)
- 📧 联系作者: QykXczj

---

## 🙏 致谢

感谢所有用户的反馈和支持，帮助我们发现并修复这些问题！

---

**上一版本**: [v3.1.2](./当前版本总结_v3.1.2.md)  
**下一版本**: 开发中...

[返回文档首页](../README.md)
