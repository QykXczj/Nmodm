# Nmodm v3.1.4 版本总结

**发布日期**: 2025-01-20  
**版本类型**: 功能增强 + Bug 修复版本

---

## 📋 版本概述

v3.1.4 是一个重要的功能增强版本，主要新增了 **nrsc.dll 预加载功能**，优化了预设方案编辑体验，并修复了多个 UI 和交互问题。此版本显著提升了 MOD 配置的灵活性和用户体验。

---

## ✨ 新功能

### 1. nrsc.dll 预加载功能

**功能描述**:
- 为 SeamlessCoop 的 nrsc.dll 添加预加载（load_early）支持
- 启用预加载后，nrsc.dll 将在游戏启动早期加载，不再强制 nighter.dll → nrsc.dll 的加载顺序
- 支持在 MOD 配置页面和快速启动预设编辑中设置预加载

**使用场景**:
- 解决某些 MOD 组合下的加载顺序冲突
- 提高 nrsc.dll 的加载优先级
- 优化联机功能的启动速度

**实现细节**:
- **MOD 配置页面**:
  - 右键 nrsc.dll，选择"预加载"/"取消预加载"
  - 列表显示 `🚀 nrsc.dll [预加载]` 状态
  - 配置预览显示 `load_early = true`
  - 取消勾选时自动清除预加载状态
  - 未勾选时设置预加载显示错误提示

- **快速启动 - 预设编辑对话框**:
  - 使用临时状态管理预加载（`self.preload_dlls`）
  - 右键菜单添加预加载选项
  - 保存预设时写入 `load_early = true`
  - 编辑预设时正确恢复预加载状态
  - 更新预设后自动清空临时状态

**配置文件格式**:
```toml
[[natives]]
path = "../SeamlessCoop/nrsc.dll"
load_early = true  # 预加载标记
```

**影响文件**:
- `src/config/mod_config_manager.py`: 添加 `set_native_load_early()` 和 `get_native_load_early()` 方法
- `src/ui/pages/mods_page.py`: 添加预加载右键菜单和状态显示
- `src/ui/pages/quick_launch_page.py`: 预设编辑对话框支持预加载
- `src/i18n/locales/*/mods_page.json`: 添加预加载相关翻译
- `src/i18n/locales/*/quick_launch_page.json`: 添加预加载相关翻译

---

### 2. 预设编辑对话框 UI 优化

**状态提示标签**:
- 在"创建预设方案"选项卡左下角添加状态标签
- 替换所有弹窗提示为状态标签提示（3秒自动消失）
- 支持成功（绿色）、错误（红色）、信息（蓝色）三种状态

**选项卡标题动态更新**:
- 编辑预设时，"创建预设"选项卡改为"✏️ 编辑预设"
- 更新完成后自动恢复为"📝 创建预设"

**预览配置布局优化**:
- 将"预设信息"和"配置文件内容"改为水平布局
- 左侧：预设信息（固定宽度 320px）
- 右侧：配置文件内容（占据剩余空间）

**关闭按钮优化**:
- 增大字体大小（14px → 20px）
- 改为粉红色（`#f38ba8`），提高可见性

---

### 3. 强制加载功能完善

**勾选状态检查**:
- "预加载"、"强制最后加载"、"强制优先加载"功能现在会检查 MOD/DLL 是否已勾选
- 未勾选时显示错误提示，防止误操作

**右键菜单翻译**:
- 修复预设编辑对话框中右键菜单的硬编码中文文本
- 支持中英文实时切换

---

## 🐛 Bug 修复

### 1. 预设编辑对话框问题修复

**文件名保留问题**:
- 修复：更新预设后，文件名输入框没有清空
- 解决：在 `save_preset()` 中添加 `self.filename_edit.clear()`

**预加载状态显示问题**:
- 修复：编辑已有预加载的预设时，列表不显示预加载状态
- 解决：在 `edit_preset()` 中恢复 `self.preload_dlls` 后调用 `load_available_mods()`

**预加载状态复原问题**:
- 修复：更新预设后，预加载状态没有清空
- 解决：在 `save_preset()` 中清空所有临时状态（`preload_dlls`、`force_load_last_mods`、`force_load_first_dlls`）

**DLL 名称匹配问题**:
- 修复：检查 DLL 是否已勾选时，路径匹配失败（`SeamlessCoop/nrsc.dll` vs `nrsc.dll`）
- 解决：提取文件名进行比较

---

### 2. 快速启动页面问题修复

**复选框悬停效果问题**（2处）:
- 修复：选中状态下悬停时样式丢失
- 解决：添加 `QCheckBox::indicator:checked:hover` 样式

**描述显示问题**:
- 修复：空描述时配置文件中仍然写入描述行
- 解决：在 `generate_config_content()` 中，当描述为空时不写入描述行

---

## 🔧 技术细节

### 预加载功能实现架构

**1. 数据模型层** (`ModConfigManager`):
```python
class ModNative:
    load_early: bool = False  # 预加载标记

def set_native_load_early(dll_name: str, load_early: bool) -> bool:
    # 检查 DLL 是否已启用
    # 设置预加载状态
    # 更新加载顺序逻辑
    
def get_native_load_early(dll_name: str) -> bool:
    # 读取预加载状态
```

**2. UI 层** (两种环境):
- **MOD 配置页面**: 直接操作 `ModConfigManager`，修改 `Mods/current.me3`
- **预设编辑对话框**: 使用临时状态 `self.preload_dlls`，保存时写入新的 .me3 文件

**3. 配置文件解析**:
```python
def parse_preset_file_detailed():
    # 解析 load_early = true
    # 提取文件名添加到 preload_dlls
    
def generate_config_content():
    # 从临时状态读取预加载信息
    # 写入 load_early = true
    # 跳过 nighter.dll 依赖
```

---

### 状态管理优化

**临时状态变量**:
```python
self.preload_dlls = set()           # 预加载 DLL
self.force_load_last_mods = set()   # 强制最后加载的 MOD
self.force_load_first_dlls = set()  # 强制优先加载的 DLL
```

**状态生命周期**:
1. **创建预设**: 临时状态为空
2. **编辑预设**: 从 .me3 文件恢复临时状态
3. **保存预设**: 临时状态写入 .me3 文件
4. **更新完成**: 清空所有临时状态

---

## 📊 影响范围

### 受益用户
- 使用 SeamlessCoop 联机功能的用户
- 需要自定义 MOD 加载顺序的用户
- 使用快速启动预设功能的用户

### 兼容性
- ✅ 向后兼容：不影响现有配置文件
- ✅ 可选功能：预加载功能默认关闭
- ✅ 配置迁移：旧版本配置文件可正常使用

---

## 🎯 测试建议

### 测试场景 1: MOD 配置页面预加载
1. 打开"MOD配置"页面
2. 勾选 nighter.dll 和 nrsc.dll
3. 右键 nrsc.dll，选择"预加载"
4. 检查：
   - ✅ 列表显示 `🚀 nrsc.dll [预加载]`
   - ✅ 配置预览显示 `load_early = true`
   - ✅ 状态栏显示成功提示
5. 取消勾选 nrsc.dll
6. 检查：
   - ✅ 预加载状态自动清除

### 测试场景 2: 预设编辑对话框预加载
1. 打开"快速启动"页面，点击"编辑预设方案"
2. 在"创建预设"选项卡中：
   - 勾选 nighter.dll 和 nrsc.dll
   - 右键 nrsc.dll，选择"预加载"
3. 检查：
   - ✅ 左下角状态标签显示成功提示
   - ✅ 列表显示 `🚀 nrsc.dll [预加载]`
4. 保存预设，查看 .me3 文件
5. 检查：
   - ✅ 文件中有 `load_early = true`
   - ✅ nighter.dll 没有 `load_before` 依赖

### 测试场景 3: 编辑已有预设
1. 在"管理预设"中点击"编辑"按钮
2. 检查：
   - ✅ 选项卡标题显示"✏️ 编辑预设"
   - ✅ 如果有预加载，列表正确显示
3. 更新预设
4. 检查：
   - ✅ 选项卡标题恢复为"📝 创建预设"
   - ✅ 文件名输入框已清空
   - ✅ 预加载状态已清空

### 测试场景 4: 未勾选时设置功能
1. 在预设编辑对话框中，不勾选 nrsc.dll
2. 右键 nrsc.dll，选择"预加载"
3. 检查：
   - ✅ 左下角显示红色错误提示
   - ✅ 预加载未设置成功

---

## 🚀 升级指南

### 从 v3.1.3 升级

**方式 1: 使用安装包（推荐）**
1. 下载 `Nmodm_v3.1.4-Setup.exe`
2. 运行安装程序（会自动覆盖旧版本）
3. 启动 Nmodm，版本号应显示为 v3.1.4

**方式 2: 使用便携版**
1. 下载 `Nmodm_v3.1.4.zip`
2. 解压到新目录
3. 复制旧版本的配置文件：
   - `Mods/current.me3`
   - `Mods/list/*.me3`（预设方案）
   - 其他配置文件

**注意事项**:
- ✅ 所有配置和数据都会保留
- ✅ 预加载功能默认关闭，不影响现有配置
- ✅ 旧版本的预设方案可正常使用

---

## 📝 已知问题

暂无已知问题。

---

## 🔮 下一版本计划

- 更多 DLL 的预加载支持
- 预设方案导入/导出功能
- MOD 冲突检测
- 性能优化

---

## 📞 反馈与支持

如果您在使用过程中遇到问题，请通过以下方式反馈：

- 🐛 [报告 Bug](https://github.com/QykXczj/Nmodm/issues)
- 💡 [功能建议](https://github.com/QykXczj/Nmodm/issues)
- 📧 联系作者: QykXczj

---

## 🙏 致谢

感谢所有用户的反馈和支持，特别是对预加载功能的需求反馈！

---

**上一版本**: [v3.1.3](./当前版本总结_v3.1.3.md)  
**下一版本**: 开发中...

[返回文档首页](../README.md)
