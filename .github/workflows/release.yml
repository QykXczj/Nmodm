name: åˆ›å»ºå‘è¡Œç‰ˆ

on:
  workflow_dispatch:
    inputs:
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean
      draft:
        description: 'æ˜¯å¦ä¸ºè‰ç¨¿ç‰ˆæœ¬'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: read

jobs:
  create-release:
    runs-on: windows-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è¯»å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        Write-Host "ğŸ” ä» src/version.json è¯»å–ç‰ˆæœ¬å·"
        if (-Not (Test-Path "src/version.json")) {
          Write-Host "âŒ æœªæ‰¾åˆ° src/version.jsonï¼Œé€€å‡º"
          exit 1
        }
        $content = Get-Content -Raw -Path src/version.json
        try {
          $obj = ConvertFrom-Json $content
        } catch {
          Write-Host "âŒ è§£æ src/version.json å¤±è´¥"
          exit 1
        }
        $version = $obj.version
        if (-not $version) {
          Write-Host "âŒ version å­—æ®µä¸ºç©º"
          exit 1
        }
        # ç§»é™¤å¯èƒ½å­˜åœ¨çš„ v å‰ç¼€ï¼Œå¾—åˆ°çº¯æ•°å­—ç‰ˆæœ¬
        $versionNumber = $version.TrimStart('v')
        # æ·»åŠ  v å‰ç¼€ï¼Œç”¨äºæ ‡ç­¾
        $versionTag = "v$versionNumber"
        Write-Host "âœ… è¯»å–ç‰ˆæœ¬: $versionTag (æ ‡ç­¾), $versionNumber (æ–‡ä»¶å)"
        # è¾“å‡ºä¸¤ä¸ªå˜é‡
        echo "version=$versionTag" >> $env:GITHUB_OUTPUT
        echo "version_number=$versionNumber" >> $env:GITHUB_OUTPUT

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install nuitka

    - name: åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        New-Item -ItemType Directory -Force -Path "OnlineFix"
        New-Item -ItemType Directory -Force -Path "Mods"
        "OnlineFix64.dll" | Out-File -FilePath "OnlineFix/dlllist.txt" -Encoding UTF8

    - name: ä½¿ç”¨ Nuitka æ‰“åŒ… (ç›®å½•ç‰ˆ)
      run: |
        Write-Host "ğŸ”¨ ç›´æ¥è°ƒç”¨ NuitkaBuilder è¿›è¡Œæ„å»º"
        $env:PYTHONIOENCODING = "utf-8"
        python -c "
        import sys
        import os
        os.environ['PYTHONIOENCODING'] = 'utf-8'
        sys.path.append('.')
        from build_nuitka import NuitkaBuilder

        print('ğŸ¯ Nuitka è‡ªåŠ¨æ‰“åŒ…å·¥å…·')
        print('=' * 50)

        builder = NuitkaBuilder()

        # æ£€æŸ¥ç¯å¢ƒ
        if not builder.check_environment():
            print('âŒ ç¯å¢ƒæ£€æŸ¥å¤±è´¥')
            sys.exit(1)

        # æ‰§è¡Œç‹¬ç«‹æ¨¡å¼æ„å»º
        print('ğŸš€ å¼€å§‹ç‹¬ç«‹æ¨¡å¼æ‰“åŒ…...')
        if builder.build(onefile=False, verbose_mode='detailed'):
            print('âœ… ç‹¬ç«‹æ¨¡å¼æ‰“åŒ…å®Œæˆ')
        else:
            print('âŒ ç‹¬ç«‹æ¨¡å¼æ‰“åŒ…å¤±è´¥')
            sys.exit(1)
        "

    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        New-Item -ItemType Directory -Force -Path "release"

        # æŸ¥æ‰¾ Nuitka æ„å»ºè¾“å‡ºç›®å½•
        Write-Host "ğŸ” æŸ¥æ‰¾ Nuitka æ„å»ºè¾“å‡ºç›®å½•..."
        $nuitkaDir = $null
        $version = "${{ steps.get_version.outputs.version_number }}"

        # å¯èƒ½çš„ç›®å½•åç§°
        $possibleDirs = @(
          "Builds/Nuitka/Nmodm_v$version",
          "Builds/Nuitka/main.dist",
          "Builds/Nuitka/Nmodm_nuitka_standalone"
        )

        foreach ($dir in $possibleDirs) {
          if (Test-Path $dir) {
            $nuitkaDir = $dir
            Write-Host "âœ… æ‰¾åˆ°æ„å»ºç›®å½•: $nuitkaDir"
            break
          }
        }

        # å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œæœç´¢æ‰€æœ‰åŒ…å«exeæ–‡ä»¶çš„ç›®å½•
        if (-not $nuitkaDir -and (Test-Path "Builds/Nuitka")) {
          Write-Host "ğŸ” æœç´¢åŒ…å«exeæ–‡ä»¶çš„ç›®å½•..."
          $exeDirs = Get-ChildItem "Builds/Nuitka" -Directory | Where-Object {
            (Get-ChildItem $_.FullName -Filter "*.exe" -ErrorAction SilentlyContinue).Count -gt 0
          }
          if ($exeDirs.Count -gt 0) {
            $nuitkaDir = $exeDirs[0].FullName -replace [regex]::Escape((Get-Location).Path + "\"), ""
            Write-Host "âœ… æ‰¾åˆ°åŒ…å«exeçš„ç›®å½•: $nuitkaDir"
          }
        }

        if ($nuitkaDir) {
          Write-Host "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…: $nuitkaDir"

          # æ˜¾ç¤ºç›®å½•å†…å®¹
          Write-Host "ğŸ“‹ ç›®å½•å†…å®¹:"
          Get-ChildItem $nuitkaDir | Select-Object Name, Length, LastWriteTime | Format-Table

          # åˆ›å»ºå‹ç¼©åŒ…
          Compress-Archive -Path "$nuitkaDir/*" -DestinationPath "release/Nmodm_v${{ steps.get_version.outputs.version_number }}.zip" -Force
          Write-Host "âœ… ä¸»å‘å¸ƒåŒ…å·²åˆ›å»º: Nmodm_v${{ steps.get_version.outputs.version_number }}.zip"
        } else {
          Write-Host "âŒ æœªæ‰¾åˆ° Nuitka æ„å»ºè¾“å‡º"
          Write-Host "ğŸ“‹ Builds ç›®å½•ç»“æ„:"
          if (Test-Path "Builds") {
            Get-ChildItem "Builds" -Recurse | Select-Object FullName, Length | Format-Table
          } else {
            Write-Host "Builds ç›®å½•ä¸å­˜åœ¨"
          }
          exit 1
        }

        # åˆ›å»ºæºä»£ç åŒ…
        $sourceFiles = @("src", "OnlineFix", "main.py", "requirements.txt", "README.md", "LICENSE")
        $existingFiles = @()
        foreach ($file in $sourceFiles) {
          if (Test-Path $file) {
            $existingFiles += $file
          }
        }
        if ($existingFiles.Count -gt 0) {
          Compress-Archive -Path $existingFiles -DestinationPath "release/Nmodm_Source_v${{ steps.get_version.outputs.version_number }}.zip"
          Write-Host "Source code package created: Nmodm_Source_v${{ steps.get_version.outputs.version_number }}.zip"
        }

    - name: åˆ›å»º Inno Setup è„šæœ¬
      run: |
        # æŸ¥æ‰¾ Nuitka æ„å»ºè¾“å‡ºç›®å½• (ä¸å‘å¸ƒåŒ…åˆ›å»ºæ­¥éª¤ä¿æŒä¸€è‡´)
        Write-Host "ğŸ” æŸ¥æ‰¾ Nuitka æ„å»ºè¾“å‡ºç›®å½•..."
        $nuitkaDir = $null
        $version = "${{ steps.get_version.outputs.version_number }}"

        # å¯èƒ½çš„ç›®å½•åç§°
        $possibleDirs = @(
          "Builds/Nuitka/Nmodm_v$version",
          "Builds/Nuitka/main.dist",
          "Builds/Nuitka/Nmodm_nuitka_standalone"
        )

        foreach ($dir in $possibleDirs) {
          if (Test-Path $dir) {
            $nuitkaDir = $dir
            Write-Host "âœ… æ‰¾åˆ°æ„å»ºç›®å½•: $nuitkaDir"
            break
          }
        }

        # å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œæœç´¢æ‰€æœ‰åŒ…å«exeæ–‡ä»¶çš„ç›®å½•
        if (-not $nuitkaDir -and (Test-Path "Builds/Nuitka")) {
          Write-Host "ğŸ” æœç´¢åŒ…å«exeæ–‡ä»¶çš„ç›®å½•..."
          $exeDirs = Get-ChildItem "Builds/Nuitka" -Directory | Where-Object {
            (Get-ChildItem $_.FullName -Filter "*.exe" -ErrorAction SilentlyContinue).Count -gt 0
          }
          if ($exeDirs.Count -gt 0) {
            $nuitkaDir = $exeDirs[0].FullName -replace [regex]::Escape((Get-Location).Path + "\"), ""
            Write-Host "âœ… æ‰¾åˆ°åŒ…å«exeçš„ç›®å½•: $nuitkaDir"
          }
        }

        if (-not $nuitkaDir) {
          Write-Host "âŒ æœªæ‰¾åˆ° Nuitka æ„å»ºè¾“å‡ºç›®å½•"
          Write-Host "ğŸ“‹ Builds ç›®å½•ç»“æ„:"
          if (Test-Path "Builds") {
            Get-ChildItem "Builds" -Recurse | Select-Object FullName | Format-Table
          } else {
            Write-Host "Builds ç›®å½•ä¸å­˜åœ¨"
          }
          exit 1
        }

        Write-Host "âœ… ä½¿ç”¨æ„å»ºç›®å½•: $nuitkaDir"

        # åŠ¨æ€åˆ›å»º Inno Setup è„šæœ¬ (ç‰ˆæœ¬å·²åœ¨ä¸Šé¢å®šä¹‰)

        # åˆ›å»ºè„šæœ¬å†…å®¹
        $setupSection = "[Setup]"
        $setupSection += "`nAppName=Nmodm"
        $setupSection += "`nAppVersion=$version"
        $setupSection += "`nAppPublisher=QykXczj"
        $setupSection += "`nDefaultDirName={src}\Nmodm_v$version"
        $setupSection += "`nDefaultGroupName=Nmodm"
        $setupSection += "`nOutputDir=release"
        $setupSection += "`nOutputBaseFilename=Nmodm_v$version-Setup"
        $setupSection += "`nCompression=lzma2"
        $setupSection += "`nSolidCompression=yes"
        $setupSection += "`nUninstallDisplayIcon={app}\Nmodm.exe"
        $setupSection += "`nCreateUninstallRegKey=yes"
        $setupSection += "`nMinVersion=6.1sp1"
        $setupSection += "`nArchitecturesAllowed=x64"
        $setupSection += "`nArchitecturesInstallIn64BitMode=x64"

        # æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯
        $setupSection += "`nAppCopyright=Copyright Â© 2025"
        $setupSection += "`nAppComments=Nmodm - æ¸¸æˆæ¨¡ç»„ç®¡ç†å™¨"
        $setupSection += "`nVersionInfoVersion=$version.0"
        $setupSection += "`nVersionInfoDescription=Nmodm - æ¸¸æˆæ¨¡ç»„ç®¡ç†å™¨"
        $setupSection += "`nVersionInfoCopyright=Copyright Â© 2025"
        $setupSection += "`nVersionInfoProductName=Nmodm"
        $setupSection += "`nVersionInfoProductVersion=$version.0"

        # æ·»åŠ å›¾æ ‡æ”¯æŒ
        if (Test-Path "zwnr.ico") {
          $setupSection += "`nSetupIconFile=zwnr.ico"
        }

        # æ·»åŠ å¤šè¯­è¨€æ”¯æŒ
        $setupSection += "`n"
        $setupSection += "`n; å¤šè¯­è¨€æ”¯æŒ"
        $setupSection += "`nShowLanguageDialog=yes"

        $languagesSection = "`n`n[Languages]"
        # è‹±æ–‡ï¼ˆé»˜è®¤ï¼‰
        $languagesSection += "`nName: `"en`"; MessagesFile: `"compiler:Default.isl`""
        # ç®€ä½“ä¸­æ–‡
        if (Test-Path "ChineseSimplified.isl") {
          $languagesSection += "`nName: `"chinesesimplified`"; MessagesFile: `"ChineseSimplified.isl`""
        } else {
          $languagesSection += "`nName: `"chinesesimplified`"; MessagesFile: `"compiler:Languages\ChineseSimplified.isl`""
        }

        $filesSection = "`n`n[Files]"
        $filesSection += "`nSource: `"$nuitkaDir\*`"; DestDir: `"{app}`"; Flags: ignoreversion recursesubdirs createallsubdirs"

        $iconsSection = "`n`n[Icons]"
        $iconsSection += "`nName: `"{group}\Nmodm`"; Filename: `"{app}\Nmodm.exe`""
        $iconsSection += "`nName: `"{autodesktop}\Nmodm`"; Filename: `"{app}\Nmodm.exe`"; Tasks: desktopicon"

        $tasksSection = "`n`n[Tasks]"
        # è‹±æ–‡æè¿°
        $tasksSection += "`nName: `"desktopicon`"; Description: `"{cm:CreateDesktopIcon}`"; GroupDescription: `"{cm:AdditionalIcons}`"; Flags: unchecked"

        $runSection = "`n`n[Run]"
        # ä½¿ç”¨ CustomMessages ä¸­çš„æ¶ˆæ¯
        $runSection += "`nFilename: `"{app}\Nmodm.exe`"; Description: `"{cm:LaunchProgram,Nmodm}`"; Flags: nowait postinstall skipifsilent"

        $customMessagesSection = "`n`n[CustomMessages]"
        # è‹±æ–‡è‡ªå®šä¹‰æ¶ˆæ¯
        $customMessagesSection += "`nen.LaunchProgram=Launch %1"
        # ä¸­æ–‡è‡ªå®šä¹‰æ¶ˆæ¯
        $customMessagesSection += "`nchinesesimplified.LaunchProgram=å¯åŠ¨ %1"

        # ç»„åˆæ‰€æœ‰éƒ¨åˆ†
        $issContent = $setupSection + $languagesSection + $filesSection + $iconsSection + $tasksSection + $runSection + $customMessagesSection

        # å†™å…¥æ–‡ä»¶
        $issContent | Out-File -FilePath "setup.iss" -Encoding UTF8
        Write-Host "âœ… Inno Setup è„šæœ¬å·²åˆ›å»º"

        # éªŒè¯è„šæœ¬å†…å®¹
        Write-Host "ğŸ“‹ è„šæœ¬å†…å®¹é¢„è§ˆ:"
        Get-Content "setup.iss" | Select-Object -First 10 | Write-Host

    - name: éªŒè¯ Inno Setup è„šæœ¬
      run: |
        Write-Host "ğŸ“‹ å½“å‰å·¥ä½œç›®å½•: $(Get-Location)"
        Write-Host "ğŸ“‹ ç›®å½•å†…å®¹:"
        Get-ChildItem | Select-Object Name, Length, LastWriteTime | Format-Table

        if (Test-Path "setup.iss") {
          Write-Host "âœ… Inno Setup è„šæœ¬å­˜åœ¨"
          Write-Host "ğŸ“‹ è„šæœ¬æ–‡ä»¶å¤§å°: $((Get-Item 'setup.iss').Length) å­—èŠ‚"
          Write-Host "ğŸ“‹ è„šæœ¬ç»å¯¹è·¯å¾„: $((Get-Item 'setup.iss').FullName)"
          Write-Host "ğŸ“‹ è„šæœ¬å†…å®¹:"
          Get-Content "setup.iss" | Write-Host
        } else {
          Write-Host "âŒ Inno Setup è„šæœ¬ä¸å­˜åœ¨"
          Write-Host "ğŸ“‹ æŸ¥æ‰¾æ‰€æœ‰ .iss æ–‡ä»¶:"
          Get-ChildItem -Recurse -Filter "*.iss" | Select-Object FullName | Write-Host
          exit 1
        }

    - name: ä½¿ç”¨ Chocolatey å®‰è£… Inno Setup
      run: |
        Write-Host "ğŸ“¦ å®‰è£… Inno Setup"
        choco install innosetup -y
        Write-Host "âœ… Inno Setup å®‰è£…å®Œæˆ"

    - name: æ‰‹åŠ¨æ„å»º Windows å®‰è£…åŒ…
      run: |
        Write-Host "ğŸ”¨ æ‰‹åŠ¨ç¼–è¯‘ Inno Setup è„šæœ¬"

        # æŸ¥æ‰¾ ISCC.exe
        $isccPaths = @(
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe",
          "C:\Program Files\Inno Setup 6\ISCC.exe",
          "C:\tools\InnoSetup\ISCC.exe"
        )

        $isccPath = $null
        foreach ($path in $isccPaths) {
          if (Test-Path $path) {
            $isccPath = $path
            Write-Host "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $isccPath"
            break
          }
        }

        if (-not $isccPath) {
          Write-Host "âŒ æ‰¾ä¸åˆ° Inno Setup ç¼–è¯‘å™¨"
          Write-Host "ğŸ“‹ æœç´¢æ‰€æœ‰å¯èƒ½çš„ ISCC.exe:"
          Get-ChildItem -Path "C:\" -Recurse -Name "ISCC.exe" -ErrorAction SilentlyContinue | Write-Host
          exit 1
        }

        # ç¼–è¯‘è„šæœ¬
        Write-Host "ğŸ”¨ å¼€å§‹ç¼–è¯‘..."
        & "$isccPath" "setup.iss" /O+

        if ($LASTEXITCODE -eq 0) {
          Write-Host "âœ… ç¼–è¯‘æˆåŠŸ"
        } else {
          Write-Host "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $LASTEXITCODE"
          exit 1
        }

    - name: éªŒè¯å¹¶ç§»åŠ¨å®‰è£…åŒ…
      run: |
        Write-Host "ğŸ“‹ æ£€æŸ¥å¯èƒ½çš„è¾“å‡ºä½ç½®..."

        # æ£€æŸ¥å¤šä¸ªå¯èƒ½çš„è¾“å‡ºä½ç½®
        $possiblePaths = @("Output", "release", ".")
        $foundExe = $false

        foreach ($path in $possiblePaths) {
          if (Test-Path $path) {
            Write-Host "âœ… æ£€æŸ¥ç›®å½•: $path"
            $exeFiles = Get-ChildItem "$path\*.exe" -ErrorAction SilentlyContinue
            if ($exeFiles.Count -gt 0) {
              Write-Host "âœ… åœ¨ $path ä¸­æ‰¾åˆ° $($exeFiles.Count) ä¸ª .exe æ–‡ä»¶"
              foreach ($file in $exeFiles) {
                Write-Host "  - $($file.Name) ($($file.Length) å­—èŠ‚)"
                # å¦‚æœä¸åœ¨ release ç›®å½•ï¼Œç§»åŠ¨åˆ° release ç›®å½•
                if ($path -ne "release") {
                  if (-not (Test-Path "release")) {
                    New-Item -ItemType Directory -Path "release" -Force
                  }
                  Move-Item $file.FullName "release\" -Force
                  Write-Host "  âœ… å·²ç§»åŠ¨åˆ° release ç›®å½•"
                }
              }
              $foundExe = $true
              break
            } else {
              Write-Host "  âŒ åœ¨ $path ä¸­æœªæ‰¾åˆ° .exe æ–‡ä»¶"
            }
          } else {
            Write-Host "  âŒ ç›®å½• $path ä¸å­˜åœ¨"
          }
        }

        if (-not $foundExe) {
          Write-Host "âŒ åœ¨æ‰€æœ‰å¯èƒ½ä½ç½®éƒ½æœªæ‰¾åˆ°å®‰è£…åŒ…æ–‡ä»¶"
          Write-Host "ğŸ“‹ å½“å‰ç›®å½•å®Œæ•´å†…å®¹:"
          Get-ChildItem -Recurse | Where-Object { $_.Extension -eq ".exe" } | Select-Object FullName, Length | Format-Table
          exit 1
        }

        # æ˜¾ç¤ºæœ€ç»ˆå‘å¸ƒç›®å½•å†…å®¹
        Write-Host "ğŸ“¦ å‘å¸ƒç›®å½•æœ€ç»ˆå†…å®¹:"
        if (Test-Path "release") {
          Get-ChildItem "release" | Select-Object Name, Length, LastWriteTime | Format-Table
        } else {
          Write-Host "âŒ release ç›®å½•ä¸å­˜åœ¨"
        }

    - name: æå–æ›´æ–°æ—¥å¿—
      id: extract_changelog
      run: |
        Write-Host "ğŸ“‹ æå–æ›´æ–°æ—¥å¿—..."
        
        $version = "${{ steps.get_version.outputs.version }}"
        $versionNumber = $version.TrimStart('v')
        
        # æ–¹æ¡ˆ1: ä»ç‰ˆæœ¬æ€»ç»“æ–‡æ¡£æå–ï¼ˆä¼˜å…ˆï¼‰
        $summaryFile = "docs/å½“å‰ç‰ˆæœ¬æ€»ç»“_v$versionNumber.md"
        if (Test-Path $summaryFile) {
          Write-Host "âœ… æ‰¾åˆ°ç‰ˆæœ¬æ€»ç»“æ–‡æ¡£: $summaryFile"
          
          $summaryContent = Get-Content $summaryFile -Raw -Encoding UTF8
          
          # æå–"Bug ä¿®å¤"éƒ¨åˆ†ä½œä¸ºä¸­æ–‡å†…å®¹
          $patternZh = "(?s)## ğŸ› Bug ä¿®å¤(.*?)(?=\n## |$)"
          if ($summaryContent -match $patternZh) {
            $zhContent = $matches[1].Trim()
            Write-Host "âœ… æˆåŠŸä»ç‰ˆæœ¬æ€»ç»“æå–ä¸­æ–‡å†…å®¹"
          } else {
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œæå–æ•´ä¸ª"ç‰ˆæœ¬æ¦‚è¿°"åˆ°ç¬¬ä¸€ä¸ªäºŒçº§æ ‡é¢˜
            $patternZh = "(?s)## ğŸ“‹ ç‰ˆæœ¬æ¦‚è¿°(.*?)(?=\n## |$)"
            if ($summaryContent -match $patternZh) {
              $zhContent = $matches[1].Trim()
              Write-Host "âœ… æˆåŠŸæå–ç‰ˆæœ¬æ¦‚è¿°ä½œä¸ºä¸­æ–‡å†…å®¹"
            } else {
              $zhContent = "v$versionNumber ç‰ˆæœ¬æ›´æ–°ï¼Œè¯¦è§å®Œæ•´æ›´æ–°æ—¥å¿—"
              Write-Host "âš ï¸ ä½¿ç”¨é»˜è®¤ä¸­æ–‡å†…å®¹"
            }
          }
          
          # è‹±æ–‡å†…å®¹ä» CHANGELOG æå–
          $changelogEn = Get-Content "docs/en/CHANGELOG.md" -Raw -Encoding UTF8
          $patternEn = "(?s)## \[$versionNumber\].*?\n\n(.*?)(?=\n---|\n## \[|$)"
          if ($changelogEn -match $patternEn) {
            $enContent = $matches[1].Trim()
            Write-Host "âœ… æˆåŠŸæå–è‹±æ–‡æ›´æ–°æ—¥å¿—"
          } else {
            $enContent = "See full changelog for version $versionNumber updates"
            Write-Host "âš ï¸ ä½¿ç”¨é»˜è®¤è‹±æ–‡å†…å®¹"
          }
        } else {
          Write-Host "âš ï¸ æœªæ‰¾åˆ°ç‰ˆæœ¬æ€»ç»“æ–‡æ¡£ï¼Œä» CHANGELOG æå–"
          
          # æ–¹æ¡ˆ2: ä» CHANGELOG æå–ï¼ˆå¤‡ç”¨ï¼‰
          $changelogZh = Get-Content "docs/zh/CHANGELOG.md" -Raw -Encoding UTF8
          $patternZh = "(?s)## \[$versionNumber\].*?\n\n(.*?)(?=\n---|\n## \[|$)"
          if ($changelogZh -match $patternZh) {
            $zhContent = $matches[1].Trim()
            Write-Host "âœ… æˆåŠŸæå–ä¸­æ–‡æ›´æ–°æ—¥å¿—"
          } else {
            $zhContent = "v$versionNumber ç‰ˆæœ¬æ›´æ–°ï¼Œè¯¦è§å®Œæ•´æ›´æ–°æ—¥å¿—"
            Write-Host "âš ï¸ ä½¿ç”¨é»˜è®¤ä¸­æ–‡å†…å®¹"
          }
          
          $changelogEn = Get-Content "docs/en/CHANGELOG.md" -Raw -Encoding UTF8
          $patternEn = "(?s)## \[$versionNumber\].*?\n\n(.*?)(?=\n---|\n## \[|$)"
          if ($changelogEn -match $patternEn) {
            $enContent = $matches[1].Trim()
            Write-Host "âœ… æˆåŠŸæå–è‹±æ–‡æ›´æ–°æ—¥å¿—"
          } else {
            $enContent = "See full changelog for version $versionNumber updates"
            Write-Host "âš ï¸ ä½¿ç”¨é»˜è®¤è‹±æ–‡å†…å®¹"
          }
        }
        
        # æ„å»ºå®Œæ•´çš„å‘è¡Œè¯´æ˜
        $releaseBody = @"
        ## ğŸ® Nmodm $version

        **Nmodm** - è‰¾å°”ç™»æ³•ç¯ï¼šå¤œä¹‹å›ä¸´ æ¨¡ç»„ç®¡ç†å·¥å…· | Elden Ring: Nightreign Mod Manager

        ---

        ### âœ¨ ä¸»è¦æ›´æ–° | What's New

        #### ğŸ‡¨ğŸ‡³ ä¸­æ–‡ | Chinese

        $zhContent

        #### ğŸ‡¬ğŸ‡§ English

        $enContent

        ---

        ğŸ“– **å®Œæ•´æ›´æ–°æ—¥å¿—** | Full Changelog: [ä¸­æ–‡](https://github.com/QykXczj/Nmodm/blob/main/docs/zh/CHANGELOG.md) | [English](https://github.com/QykXczj/Nmodm/blob/main/docs/en/CHANGELOG.md)

        ---

        ### ğŸ“¦ ä¸‹è½½è¯´æ˜ | Download Guide

        #### ğŸ”¹ æ¨èä¸‹è½½ | Recommended

        - **``Nmodm_v$versionNumber-Setup.exe``** - Windows å®‰è£…åŒ… | Windows Installer
          - âœ… è‡ªåŠ¨å®‰è£…ï¼Œåˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼ | Auto-install with desktop shortcut
          - âœ… æ”¯æŒå¸è½½ | Supports uninstallation
          - âœ… é€‚åˆé•¿æœŸä½¿ç”¨ | Best for long-term use

        #### ğŸ”¹ ä¾¿æºç‰ˆ | Portable Version

        - **``Nmodm_v$versionNumber.zip``** - ä¾¿æºç‰ˆå‹ç¼©åŒ… | Portable ZIP
          - âœ… è§£å‹å³ç”¨ï¼Œæ— éœ€å®‰è£… | Extract and run, no installation needed
          - âœ… é€‚åˆä¸´æ—¶ä½¿ç”¨æˆ–Uç›˜æºå¸¦ | Good for temporary use or USB drive
          - âš ï¸ éœ€æ‰‹åŠ¨è§£å‹åˆ°éä¸­æ–‡è·¯å¾„ | Extract to non-Chinese path

        ---

        ### ğŸš€ å¿«é€Ÿå¼€å§‹ | Quick Start

        #### å®‰è£…ç‰ˆ | Installer Version
        1. ä¸‹è½½ ``Nmodm_v$versionNumber-Setup.exe``
        2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº | Double-click to run installer
        3. é€‰æ‹©å®‰è£…è·¯å¾„ï¼ˆå»ºè®®éä¸­æ–‡è·¯å¾„ï¼‰| Choose installation path (non-Chinese recommended)
        4. å®Œæˆå®‰è£…ï¼Œå¯åŠ¨ Nmodm | Complete installation and launch Nmodm

        #### ä¾¿æºç‰ˆ | Portable Version
        1. ä¸‹è½½ ``Nmodm_v$versionNumber.zip``
        2. è§£å‹åˆ°éä¸­æ–‡è·¯å¾„ | Extract to non-Chinese path
        3. è¿è¡Œ ``Nmodm.exe`` | Run ``Nmodm.exe``

        #### é¦–æ¬¡ä½¿ç”¨ | First Time Use
        1. åœ¨"é…ç½®"é¡µé¢è®¾ç½®æ¸¸æˆè·¯å¾„ | Set game path in "Config" page
        2. åœ¨"å·¥å…·ä¸‹è½½"é¡µé¢ä¸‹è½½ ME3 å·¥å…· | Download ME3 tools in "Tool Download" page
        3. åœ¨"æ¨¡ç»„é…ç½®"é¡µé¢ç®¡ç†æ¨¡ç»„ | Manage mods in "Mod Config" page
        4. åœ¨"å¿«é€Ÿå¯åŠ¨"é¡µé¢å¯åŠ¨æ¸¸æˆ | Launch game in "Quick Launch" page

        ---

        ### ğŸ“š æ–‡æ¡£ | Documentation

        - ğŸ“– [ç”¨æˆ·æŒ‡å— | User Guide](https://github.com/QykXczj/Nmodm/blob/main/docs/zh/USER_GUIDE.md) ([EN](https://github.com/QykXczj/Nmodm/blob/main/docs/en/USER_GUIDE.md))
        - ğŸ‘¨â€ğŸ’» [å¼€å‘æŒ‡å— | Developer Guide](https://github.com/QykXczj/Nmodm/blob/main/docs/zh/DEVELOPER_GUIDE.md) ([EN](https://github.com/QykXczj/Nmodm/blob/main/docs/en/DEVELOPER_GUIDE.md))
        - ğŸ¤ [è´¡çŒ®æŒ‡å— | Contributing](https://github.com/QykXczj/Nmodm/blob/main/docs/zh/CONTRIBUTING.md) ([EN](https://github.com/QykXczj/Nmodm/blob/main/docs/en/CONTRIBUTING.md))

        ---

        ### âš ï¸ ç³»ç»Ÿè¦æ±‚ | System Requirements

        - Windows 10/11 (64-bit)
        - .NET Framework 4.7.2+ (å®‰è£…ç‰ˆä¼šè‡ªåŠ¨æ£€æµ‹ | Installer auto-detects)
        - 500MB å¯ç”¨ç£ç›˜ç©ºé—´ | 500MB free disk space

        ---

        ### ğŸ’¬ åé¦ˆä¸æ”¯æŒ | Feedback & Support

        - ğŸ› [æŠ¥å‘Šé—®é¢˜ | Report Issues](https://github.com/QykXczj/Nmodm/issues)
        - ğŸ’¡ [åŠŸèƒ½å»ºè®® | Feature Requests](https://github.com/QykXczj/Nmodm/issues)
        - ğŸ“§ è”ç³»ä½œè€… | Contact: QykXczj

        ---

        **æ„Ÿè°¢ä½¿ç”¨ Nmodmï¼| Thanks for using Nmodm!** ğŸ‰
        "@
        
        # ä¿å­˜åˆ°æ–‡ä»¶
        $releaseBody | Out-File -FilePath "release_body.txt" -Encoding UTF8 -NoNewline
        
        Write-Host "ğŸ“ å‘è¡Œè¯´æ˜å·²ç”Ÿæˆ"
        
    - name: åˆ›å»ºå‘è¡Œç‰ˆ
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: Nmodm ${{ steps.get_version.outputs.version }}
        body_path: release_body.txt
        draft: ${{ github.event.inputs.draft }}
        prerelease: ${{ github.event.inputs.prerelease }}
        files: |
          release/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
