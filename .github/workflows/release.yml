name: åˆ›å»ºå‘è¡Œç‰ˆ

on:
  workflow_dispatch:
    inputs:
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean
      draft:
        description: 'æ˜¯å¦ä¸ºè‰ç¨¿ç‰ˆæœ¬'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: read

jobs:
  create-release:
    runs-on: windows-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è¯»å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        Write-Host "ğŸ” ä» src/version.json è¯»å–ç‰ˆæœ¬å·"
        if (-Not (Test-Path "src/version.json")) {
          Write-Host "âŒ æœªæ‰¾åˆ° src/version.jsonï¼Œé€€å‡º"
          exit 1
        }
        $content = Get-Content -Raw -Path src/version.json
        try {
          $obj = ConvertFrom-Json $content
        } catch {
          Write-Host "âŒ è§£æ src/version.json å¤±è´¥"
          exit 1
        }
        $version = $obj.version
        if (-not $version) {
          Write-Host "âŒ version å­—æ®µä¸ºç©º"
          exit 1
        }
        # ç§»é™¤å¯èƒ½å­˜åœ¨çš„ v å‰ç¼€
        $version = $version.TrimStart('v')
        # æ·»åŠ  v å‰ç¼€ï¼Œç¡®ä¿ç»Ÿä¸€æ ¼å¼
        $versionWithV = "v$version"
        Write-Host "âœ… è¯»å–ç‰ˆæœ¬: $versionWithV"
        echo "version=$versionWithV" >> $env:GITHUB_OUTPUT

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install nuitka

    - name: åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        New-Item -ItemType Directory -Force -Path "OnlineFix"
        New-Item -ItemType Directory -Force -Path "Mods"
        "OnlineFix64.dll" | Out-File -FilePath "OnlineFix/dlllist.txt" -Encoding UTF8

    - name: ä½¿ç”¨ Nuitka æ‰“åŒ… (ç›®å½•ç‰ˆ)
      run: |
        Write-Host "ğŸ”¨ ç›´æ¥è°ƒç”¨ NuitkaBuilder è¿›è¡Œæ„å»º"
        $env:PYTHONIOENCODING = "utf-8"
        python -c "
        import sys
        import os
        os.environ['PYTHONIOENCODING'] = 'utf-8'
        sys.path.append('.')
        from build_nuitka import NuitkaBuilder

        print('ğŸ¯ Nuitka è‡ªåŠ¨æ‰“åŒ…å·¥å…·')
        print('=' * 50)

        builder = NuitkaBuilder()

        # æ£€æŸ¥ç¯å¢ƒ
        if not builder.check_environment():
            print('âŒ ç¯å¢ƒæ£€æŸ¥å¤±è´¥')
            sys.exit(1)

        # æ‰§è¡Œç‹¬ç«‹æ¨¡å¼æ„å»º
        print('ğŸš€ å¼€å§‹ç‹¬ç«‹æ¨¡å¼æ‰“åŒ…...')
        if builder.build(onefile=False, verbose_mode='detailed'):
            print('âœ… ç‹¬ç«‹æ¨¡å¼æ‰“åŒ…å®Œæˆ')
        else:
            print('âŒ ç‹¬ç«‹æ¨¡å¼æ‰“åŒ…å¤±è´¥')
            sys.exit(1)
        "

    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        New-Item -ItemType Directory -Force -Path "release"

        # æŸ¥æ‰¾ Nuitka æ„å»ºè¾“å‡ºç›®å½•
        Write-Host "ğŸ” æŸ¥æ‰¾ Nuitka æ„å»ºè¾“å‡ºç›®å½•..."
        $nuitkaDir = $null
        $version = "${{ steps.get_version.outputs.version }}".TrimStart('v')

        # å¯èƒ½çš„ç›®å½•åç§°
        $possibleDirs = @(
          "Builds/Nuitka/Nmodm_v$version",
          "Builds/Nuitka/main.dist",
          "Builds/Nuitka/Nmodm_nuitka_standalone"
        )

        foreach ($dir in $possibleDirs) {
          if (Test-Path $dir) {
            $nuitkaDir = $dir
            Write-Host "âœ… æ‰¾åˆ°æ„å»ºç›®å½•: $nuitkaDir"
            break
          }
        }

        # å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œæœç´¢æ‰€æœ‰åŒ…å«exeæ–‡ä»¶çš„ç›®å½•
        if (-not $nuitkaDir -and (Test-Path "Builds/Nuitka")) {
          Write-Host "ğŸ” æœç´¢åŒ…å«exeæ–‡ä»¶çš„ç›®å½•..."
          $exeDirs = Get-ChildItem "Builds/Nuitka" -Directory | Where-Object {
            (Get-ChildItem $_.FullName -Filter "*.exe" -ErrorAction SilentlyContinue).Count -gt 0
          }
          if ($exeDirs.Count -gt 0) {
            $nuitkaDir = $exeDirs[0].FullName -replace [regex]::Escape((Get-Location).Path + "\"), ""
            Write-Host "âœ… æ‰¾åˆ°åŒ…å«exeçš„ç›®å½•: $nuitkaDir"
          }
        }

        if ($nuitkaDir) {
          Write-Host "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…: $nuitkaDir"

          # æ˜¾ç¤ºç›®å½•å†…å®¹
          Write-Host "ğŸ“‹ ç›®å½•å†…å®¹:"
          Get-ChildItem $nuitkaDir | Select-Object Name, Length, LastWriteTime | Format-Table

          # åˆ›å»ºå‹ç¼©åŒ…
          Compress-Archive -Path "$nuitkaDir/*" -DestinationPath "release/Nmodm_v${{ steps.get_version.outputs.version }}.zip" -Force
          Write-Host "âœ… ä¸»å‘å¸ƒåŒ…å·²åˆ›å»º: Nmodm_v${{ steps.get_version.outputs.version }}.zip"
        } else {
          Write-Host "âŒ æœªæ‰¾åˆ° Nuitka æ„å»ºè¾“å‡º"
          Write-Host "ğŸ“‹ Builds ç›®å½•ç»“æ„:"
          if (Test-Path "Builds") {
            Get-ChildItem "Builds" -Recurse | Select-Object FullName, Length | Format-Table
          } else {
            Write-Host "Builds ç›®å½•ä¸å­˜åœ¨"
          }
          exit 1
        }

        # åˆ›å»ºæºä»£ç åŒ…
        $sourceFiles = @("src", "OnlineFix", "main.py", "requirements.txt", "README.md", "LICENSE")
        $existingFiles = @()
        foreach ($file in $sourceFiles) {
          if (Test-Path $file) {
            $existingFiles += $file
          }
        }
        if ($existingFiles.Count -gt 0) {
          Compress-Archive -Path $existingFiles -DestinationPath "release/Nmodm_Source_v${{ steps.get_version.outputs.version }}.zip"
          Write-Host "Source code package created: Nmodm_Source_v${{ steps.get_version.outputs.version }}.zip"
        }

    - name: åˆ›å»º Inno Setup è„šæœ¬
      run: |
        # æŸ¥æ‰¾ Nuitka æ„å»ºè¾“å‡ºç›®å½• (ä¸å‘å¸ƒåŒ…åˆ›å»ºæ­¥éª¤ä¿æŒä¸€è‡´)
        Write-Host "ğŸ” æŸ¥æ‰¾ Nuitka æ„å»ºè¾“å‡ºç›®å½•..."
        $nuitkaDir = $null
        $version = "${{ steps.get_version.outputs.version }}".TrimStart('v')

        # å¯èƒ½çš„ç›®å½•åç§°
        $possibleDirs = @(
          "Builds/Nuitka/Nmodm_v$version",
          "Builds/Nuitka/main.dist",
          "Builds/Nuitka/Nmodm_nuitka_standalone"
        )

        foreach ($dir in $possibleDirs) {
          if (Test-Path $dir) {
            $nuitkaDir = $dir
            Write-Host "âœ… æ‰¾åˆ°æ„å»ºç›®å½•: $nuitkaDir"
            break
          }
        }

        # å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œæœç´¢æ‰€æœ‰åŒ…å«exeæ–‡ä»¶çš„ç›®å½•
        if (-not $nuitkaDir -and (Test-Path "Builds/Nuitka")) {
          Write-Host "ğŸ” æœç´¢åŒ…å«exeæ–‡ä»¶çš„ç›®å½•..."
          $exeDirs = Get-ChildItem "Builds/Nuitka" -Directory | Where-Object {
            (Get-ChildItem $_.FullName -Filter "*.exe" -ErrorAction SilentlyContinue).Count -gt 0
          }
          if ($exeDirs.Count -gt 0) {
            $nuitkaDir = $exeDirs[0].FullName -replace [regex]::Escape((Get-Location).Path + "\"), ""
            Write-Host "âœ… æ‰¾åˆ°åŒ…å«exeçš„ç›®å½•: $nuitkaDir"
          }
        }

        if (-not $nuitkaDir) {
          Write-Host "âŒ æœªæ‰¾åˆ° Nuitka æ„å»ºè¾“å‡ºç›®å½•"
          Write-Host "ğŸ“‹ Builds ç›®å½•ç»“æ„:"
          if (Test-Path "Builds") {
            Get-ChildItem "Builds" -Recurse | Select-Object FullName | Format-Table
          } else {
            Write-Host "Builds ç›®å½•ä¸å­˜åœ¨"
          }
          exit 1
        }

        Write-Host "âœ… ä½¿ç”¨æ„å»ºç›®å½•: $nuitkaDir"

        # åŠ¨æ€åˆ›å»º Inno Setup è„šæœ¬ (ç‰ˆæœ¬å·²åœ¨ä¸Šé¢å®šä¹‰)

        # åˆ›å»ºè„šæœ¬å†…å®¹
        $setupSection = "[Setup]"
        $setupSection += "`nAppName=Nmodm"
        $setupSection += "`nAppVersion=$version"
        $setupSection += "`nAppPublisher=QykXczj"
        $setupSection += "`nDefaultDirName={src}\Nmodm_v$version"
        $setupSection += "`nDefaultGroupName=Nmodm"
        $setupSection += "`nOutputDir=release"
        $setupSection += "`nOutputBaseFilename=Nmodm_v$version-Setup"
        $setupSection += "`nCompression=lzma2"
        $setupSection += "`nSolidCompression=yes"
        $setupSection += "`nUninstallDisplayName=Nmodm v$version"
        $setupSection += "`nUninstallDisplayIcon={app}\Nmodm.exe"
        $setupSection += "`nCreateUninstallRegKey=yes"
        $setupSection += "`nMinVersion=6.1sp1"
        $setupSection += "`nArchitecturesAllowed=x64"
        $setupSection += "`nArchitecturesInstallIn64BitMode=x64"

        # æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯
        $setupSection += "`nAppCopyright=Copyright Â© 2025"
        $setupSection += "`nAppComments=Nmodm - æ¸¸æˆæ¨¡ç»„ç®¡ç†å™¨"
        $setupSection += "`nVersionInfoVersion=$version.0"
        $setupSection += "`nVersionInfoDescription=Nmodm - æ¸¸æˆæ¨¡ç»„ç®¡ç†å™¨"
        $setupSection += "`nVersionInfoCopyright=Copyright Â© 2025"
        $setupSection += "`nVersionInfoProductName=Nmodm"
        $setupSection += "`nVersionInfoProductVersion=$version.0"

        # æ·»åŠ å›¾æ ‡æ”¯æŒ
        if (Test-Path "zwnr.ico") {
          $setupSection += "`nSetupIconFile=zwnr.ico"
        }

        # æ·»åŠ å¤šè¯­è¨€æ”¯æŒ
        $setupSection += "`n"
        $setupSection += "`n; å¤šè¯­è¨€æ”¯æŒ"
        $setupSection += "`nShowLanguageDialog=auto"

        $languagesSection = "`n`n[Languages]"
        # è‹±æ–‡ï¼ˆé»˜è®¤ï¼‰
        $languagesSection += "`nName: `"en`"; MessagesFile: `"compiler:Default.isl`""
        # ç®€ä½“ä¸­æ–‡
        if (Test-Path "ChineseSimplified.isl") {
          $languagesSection += "`nName: `"chinesesimplified`"; MessagesFile: `"ChineseSimplified.isl`""
        } else {
          $languagesSection += "`nName: `"chinesesimplified`"; MessagesFile: `"compiler:Languages\ChineseSimplified.isl`""
        }

        $filesSection = "`n`n[Files]"
        $filesSection += "`nSource: `"$nuitkaDir\*`"; DestDir: `"{app}`"; Flags: ignoreversion recursesubdirs createallsubdirs"

        $iconsSection = "`n`n[Icons]"
        $iconsSection += "`nName: `"{group}\Nmodm`"; Filename: `"{app}\Nmodm.exe`""
        $iconsSection += "`nName: `"{autodesktop}\Nmodm`"; Filename: `"{app}\Nmodm.exe`"; Tasks: desktopicon"

        $tasksSection = "`n`n[Tasks]"
        # è‹±æ–‡æè¿°
        $tasksSection += "`nName: `"desktopicon`"; Description: `"{cm:CreateDesktopIcon}`"; GroupDescription: `"{cm:AdditionalIcons}`"; Flags: unchecked"

        $runSection = "`n`n[Run]"
        # è‹±æ–‡æè¿°
        $runSection += "`nName: `"en`"; Filename: `"{app}\Nmodm.exe`"; Description: `"Launch Nmodm`"; Flags: nowait postinstall skipifsilent"
        # ä¸­æ–‡æè¿°
        $runSection += "`nName: `"chinesesimplified`"; Filename: `"{app}\Nmodm.exe`"; Description: `"å¯åŠ¨ Nmodm`"; Flags: nowait postinstall skipifsilent"

        $customMessagesSection = "`n`n[CustomMessages]"
        # è‹±æ–‡è‡ªå®šä¹‰æ¶ˆæ¯
        $customMessagesSection += "`nen.WelcomeLabel1=Welcome to Nmodm Setup Wizard"
        $customMessagesSection += "`nen.WelcomeLabel2=This will install Nmodm v$version on your computer"
        # ä¸­æ–‡è‡ªå®šä¹‰æ¶ˆæ¯
        $customMessagesSection += "`nchinesesimplified.WelcomeLabel1=æ¬¢è¿ä½¿ç”¨ Nmodm å®‰è£…å‘å¯¼"
        $customMessagesSection += "`nchinesesimplified.WelcomeLabel2=è¿™å°†åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šå®‰è£… Nmodm v$version"

        # ç»„åˆæ‰€æœ‰éƒ¨åˆ†
        $issContent = $setupSection + $languagesSection + $filesSection + $iconsSection + $tasksSection + $runSection + $customMessagesSection

        # å†™å…¥æ–‡ä»¶
        $issContent | Out-File -FilePath "setup.iss" -Encoding UTF8
        Write-Host "âœ… Inno Setup è„šæœ¬å·²åˆ›å»º"

        # éªŒè¯è„šæœ¬å†…å®¹
        Write-Host "ğŸ“‹ è„šæœ¬å†…å®¹é¢„è§ˆ:"
        Get-Content "setup.iss" | Select-Object -First 10 | Write-Host

    - name: éªŒè¯ Inno Setup è„šæœ¬
      run: |
        Write-Host "ğŸ“‹ å½“å‰å·¥ä½œç›®å½•: $(Get-Location)"
        Write-Host "ğŸ“‹ ç›®å½•å†…å®¹:"
        Get-ChildItem | Select-Object Name, Length, LastWriteTime | Format-Table

        if (Test-Path "setup.iss") {
          Write-Host "âœ… Inno Setup è„šæœ¬å­˜åœ¨"
          Write-Host "ğŸ“‹ è„šæœ¬æ–‡ä»¶å¤§å°: $((Get-Item 'setup.iss').Length) å­—èŠ‚"
          Write-Host "ğŸ“‹ è„šæœ¬ç»å¯¹è·¯å¾„: $((Get-Item 'setup.iss').FullName)"
          Write-Host "ğŸ“‹ è„šæœ¬å†…å®¹:"
          Get-Content "setup.iss" | Write-Host
        } else {
          Write-Host "âŒ Inno Setup è„šæœ¬ä¸å­˜åœ¨"
          Write-Host "ğŸ“‹ æŸ¥æ‰¾æ‰€æœ‰ .iss æ–‡ä»¶:"
          Get-ChildItem -Recurse -Filter "*.iss" | Select-Object FullName | Write-Host
          exit 1
        }

    - name: ä½¿ç”¨ Chocolatey å®‰è£… Inno Setup
      run: |
        Write-Host "ğŸ“¦ å®‰è£… Inno Setup"
        choco install innosetup -y
        Write-Host "âœ… Inno Setup å®‰è£…å®Œæˆ"

    - name: æ‰‹åŠ¨æ„å»º Windows å®‰è£…åŒ…
      run: |
        Write-Host "ğŸ”¨ æ‰‹åŠ¨ç¼–è¯‘ Inno Setup è„šæœ¬"

        # æŸ¥æ‰¾ ISCC.exe
        $isccPaths = @(
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe",
          "C:\Program Files\Inno Setup 6\ISCC.exe",
          "C:\tools\InnoSetup\ISCC.exe"
        )

        $isccPath = $null
        foreach ($path in $isccPaths) {
          if (Test-Path $path) {
            $isccPath = $path
            Write-Host "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $isccPath"
            break
          }
        }

        if (-not $isccPath) {
          Write-Host "âŒ æ‰¾ä¸åˆ° Inno Setup ç¼–è¯‘å™¨"
          Write-Host "ğŸ“‹ æœç´¢æ‰€æœ‰å¯èƒ½çš„ ISCC.exe:"
          Get-ChildItem -Path "C:\" -Recurse -Name "ISCC.exe" -ErrorAction SilentlyContinue | Write-Host
          exit 1
        }

        # ç¼–è¯‘è„šæœ¬
        Write-Host "ğŸ”¨ å¼€å§‹ç¼–è¯‘..."
        & "$isccPath" "setup.iss" /O+

        if ($LASTEXITCODE -eq 0) {
          Write-Host "âœ… ç¼–è¯‘æˆåŠŸ"
        } else {
          Write-Host "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $LASTEXITCODE"
          exit 1
        }

    - name: éªŒè¯å¹¶ç§»åŠ¨å®‰è£…åŒ…
      run: |
        Write-Host "ğŸ“‹ æ£€æŸ¥å¯èƒ½çš„è¾“å‡ºä½ç½®..."

        # æ£€æŸ¥å¤šä¸ªå¯èƒ½çš„è¾“å‡ºä½ç½®
        $possiblePaths = @("Output", "release", ".")
        $foundExe = $false

        foreach ($path in $possiblePaths) {
          if (Test-Path $path) {
            Write-Host "âœ… æ£€æŸ¥ç›®å½•: $path"
            $exeFiles = Get-ChildItem "$path\*.exe" -ErrorAction SilentlyContinue
            if ($exeFiles.Count -gt 0) {
              Write-Host "âœ… åœ¨ $path ä¸­æ‰¾åˆ° $($exeFiles.Count) ä¸ª .exe æ–‡ä»¶"
              foreach ($file in $exeFiles) {
                Write-Host "  - $($file.Name) ($($file.Length) å­—èŠ‚)"
                # å¦‚æœä¸åœ¨ release ç›®å½•ï¼Œç§»åŠ¨åˆ° release ç›®å½•
                if ($path -ne "release") {
                  if (-not (Test-Path "release")) {
                    New-Item -ItemType Directory -Path "release" -Force
                  }
                  Move-Item $file.FullName "release\" -Force
                  Write-Host "  âœ… å·²ç§»åŠ¨åˆ° release ç›®å½•"
                }
              }
              $foundExe = $true
              break
            } else {
              Write-Host "  âŒ åœ¨ $path ä¸­æœªæ‰¾åˆ° .exe æ–‡ä»¶"
            }
          } else {
            Write-Host "  âŒ ç›®å½• $path ä¸å­˜åœ¨"
          }
        }

        if (-not $foundExe) {
          Write-Host "âŒ åœ¨æ‰€æœ‰å¯èƒ½ä½ç½®éƒ½æœªæ‰¾åˆ°å®‰è£…åŒ…æ–‡ä»¶"
          Write-Host "ğŸ“‹ å½“å‰ç›®å½•å®Œæ•´å†…å®¹:"
          Get-ChildItem -Recurse | Where-Object { $_.Extension -eq ".exe" } | Select-Object FullName, Length | Format-Table
          exit 1
        }

        # æ˜¾ç¤ºæœ€ç»ˆå‘å¸ƒç›®å½•å†…å®¹
        Write-Host "ğŸ“¦ å‘å¸ƒç›®å½•æœ€ç»ˆå†…å®¹:"
        if (Test-Path "release") {
          Get-ChildItem "release" | Select-Object Name, Length, LastWriteTime | Format-Table
        } else {
          Write-Host "âŒ release ç›®å½•ä¸å­˜åœ¨"
        }
        
    - name: åˆ›å»ºå‘è¡Œç‰ˆ
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: Nmodm ${{ steps.get_version.outputs.version }}
        body: |
          Nmodm ${{ steps.get_version.outputs.version }} â€” release assets include installer, portable zip and source archive. See release assets for downloads and installation instructions.
        draft: ${{ github.event.inputs.draft }}
        prerelease: ${{ github.event.inputs.prerelease }}
        files: |
          release/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
